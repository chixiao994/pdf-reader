name: Android Build & Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Create local.properties
      run: |
        echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties
      
    - name: Create debug keystore
      run: |
        # åˆ›å»ºdebugç­¾åæ–‡ä»¶ï¼ˆç”¨äºReleaseæ„å»ºï¼‰
        keytool -genkey -v -keystore debug.keystore \
          -alias androiddebugkey -storepass android -keypass android \
          -keyalg RSA -keysize 2048 -validity 10000 \
          -dname "CN=Android Debug, OU=Android, O=Google, L=Mountain View, ST=California, C=US"
        
        mv debug.keystore app/debug.keystore
        echo "âœ… åˆ›å»ºdebug.keystoreå®Œæˆ"
      
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build Debug APK
      run: |
        ./gradlew assembleDebug --no-daemon --stacktrace
      
    - name: Build Release APK
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        ./gradlew assembleRelease --no-daemon --stacktrace
        
    - name: Verify APK files
      run: |
        echo "=== æ£€æŸ¥APKæ–‡ä»¶ ==="
        find app/build/outputs/apk -name "*.apk" -type f | while read file; do
          echo "æ‰¾åˆ°APK: $file"
          ls -lh "$file"
        done
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/*.apk
        
    - name: Upload Release APK
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: app/build/outputs/apk/release/*.apk
        
    # ========== è‡ªåŠ¨å‘å¸ƒ ==========
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        name: PDF Reader ${{ github.ref_name }}
        body: |
          ## ğŸ“± PDF Reader ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½APK
          ç‚¹å‡»ä¸‹æ–¹æ–‡ä»¶ä¸‹è½½APKå®‰è£…åŒ…ã€‚
          
          ### ğŸ”§ å®‰è£…è¯´æ˜
          1. ä¸‹è½½APKæ–‡ä»¶
          2. åœ¨æ‰‹æœºæ–‡ä»¶ç®¡ç†ä¸­æ‰¾åˆ°ä¸‹è½½çš„æ–‡ä»¶
          3. ç‚¹å‡»å®‰è£…
          4. å¦‚éœ€ï¼Œå¼€å¯"æœªçŸ¥æ¥æºåº”ç”¨"æƒé™
          
          ### ğŸ“ ç‰ˆæœ¬ä¿¡æ¯
          - ç‰ˆæœ¬: ${{ github.ref_name }}
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: [${{ github.sha }}](https://github.com/chixiao994/pdf-reader/commit/${{ github.sha }})
          
          ### ğŸ› é—®é¢˜åé¦ˆ
          è¯·åœ¨ [Issues](https://github.com/chixiao994/pdf-reader/issues) é¡µé¢åé¦ˆé—®é¢˜ã€‚
          
        files: |
          app/build/outputs/apk/release/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
