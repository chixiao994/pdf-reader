name: 构建APK（降级Gradle）

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 设置Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: 降级Gradle版本
      run: |
        echo "=== 降级Gradle版本 ==="
        
        # 将Gradle 8.4降级到7.6.4（与AGP 7.4.2更兼容）
        sed -i 's/gradle-8.4-bin.zip/gradle-7.6.4-bin.zip/' gradle/wrapper/gradle-wrapper.properties
        
        echo "更新后的gradle-wrapper.properties:"
        cat gradle/wrapper/gradle-wrapper.properties
        
        # 下载gradlew
        if [ ! -f "gradlew" ]; then
          wget -q https://raw.githubusercontent.com/gradle/gradle/master/gradlew
          chmod +x gradlew
        fi
        
        # 设置local.properties
        echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties
        
        # 添加compileOptions
        if ! grep -q "compileOptions" app/build.gradle; then
          echo "" >> app/build.gradle
          echo "compileOptions {" >> app/build.gradle
          echo "    sourceCompatibility JavaVersion.VERSION_17" >> app/build.gradle
          echo "    targetCompatibility JavaVersion.VERSION_17" >> app/build.gradle
          echo "}" >> app/build.gradle
        fi
        
        echo "✅ 降级完成"
    
    - name: 构建
      run: |
        chmod +x gradlew
        ./gradlew clean assembleDebug --stacktrace --no-daemon
    
    - uses: actions/upload-artifact@v4
      with:
        name: apk
        path: app/build/outputs/apk/debug/*.apk
        if-no-files-found: warn
