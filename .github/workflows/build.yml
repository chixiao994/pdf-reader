name: 构建APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: 配置Android SDK
      run: |
        # 使用系统预装的Android SDK
        SDK_ROOT="/usr/local/lib/android/sdk"
        echo "使用Android SDK路径: $SDK_ROOT"
        
        # 创建local.properties
        echo "sdk.dir=$SDK_ROOT" > local.properties
        
        # 接受许可证
        yes | $SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
    
    - name: 初始化Gradle（无here-document）
      run: |
        echo "初始化Gradle配置..."
        
        # 方法1：使用echo命令创建文件
        mkdir -p gradle/wrapper
        
        # 创建gradle-wrapper.properties（避免here-document）
        echo "distributionBase=GRADLE_USER_HOME" > gradle/wrapper/gradle-wrapper.properties
        echo "distributionPath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
        echo "distributionUrl=https://services.gradle.org/distributions/gradle-7.6.4-bin.zip" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStoreBase=GRADLE_USER_HOME" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStorePath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
        
        # 如果已有gradlew，确保可执行
        if [ -f "gradlew" ]; then
          chmod +x gradlew
          echo "已存在gradlew文件"
        fi
        
        echo "Gradle配置完成"
    
    - name: 显示项目信息
      run: |
        echo "=== 项目信息 ==="
        echo "当前目录: $(pwd)"
        echo ""
        echo "文件列表:"
        ls -la
        echo ""
        echo "Gradle配置:"
        cat gradle/wrapper/gradle-wrapper.properties 2>/dev/null || echo "无gradle-wrapper.properties"
    
    - name: 构建APK（简单方式）
      run: |
        echo "=== 开始构建 ==="
        
        # 如果有gradlew就用，否则用系统gradle
        if [ -f "gradlew" ]; then
          echo "使用gradlew构建..."
          ./gradlew clean assembleDebug --stacktrace --no-daemon
        else
          echo "使用系统gradle构建..."
          gradle clean assembleDebug --stacktrace --no-daemon
        fi
        
        echo "构建完成"
    
    - name: 查找APK文件
      run: |
        echo "=== 查找APK ==="
        
        # 查找所有APK文件
        APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null)
        
        if [ -z "$APK_FILES" ]; then
          echo "未找到APK文件"
          echo "检查build目录:"
          find app/build -type d 2>/dev/null || echo "无build目录"
        else
          echo "找到APK文件:"
          echo "$APK_FILES"
          for file in $APK_FILES; do
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            echo "  $file - $((size/1024))KB"
          done
        fi
    
    - name: 上传APK
      uses: actions/upload-artifact@v4
      with:
        name: apk-artifact
        path: |
          app/build/outputs/apk/debug/*.apk
          **/build/outputs/apk/**/*.apk
        if-no-files-found: warn
