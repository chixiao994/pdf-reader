name: 构建APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. 检出代码
      uses: actions/checkout@v4
    
    - name: 2. 设置Java环境
      uses: actions/setup-java@v4
      with:
        java-version: '11'  # Android项目推荐使用Java 11
        distribution: 'temurin'
    
    - name: 3. 设置Android SDK
      id: android-sdk
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools-version: "33.0.0"
        ndk-version: "none"  # 不需要NDK
        cmake-version: "none" # 不需要CMake
    
    - name: 4. 接受SDK许可证
      run: |
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
    
    - name: 5. 验证项目配置
      run: |
        echo "=== 项目结构验证 ==="
        echo "根目录build.gradle:"
        cat build.gradle
        echo ""
        echo "app/build.gradle:"
        cat app/build.gradle
        echo ""
        echo "settings.gradle:"
        cat settings.gradle || echo "无settings.gradle"
        echo ""
        echo "local.properties:"
        cat local.properties 2>/dev/null || echo "无local.properties，将创建"
        
        # 确保local.properties存在
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
    
    - name: 6. 设置Gradle Wrapper（关键步骤）
      run: |
        echo "=== 设置Gradle Wrapper ==="
        
        # 如果已有gradlew，更新其配置
        if [ -f "gradle/wrapper/gradle-wrapper.properties" ]; then
          echo "更新gradle-wrapper.properties..."
          sed -i 's/distributionUrl=.*/distributionUrl=https\:\/\/services.gradle.org\/distributions\/gradle-7.6.4-all.zip/' gradle/wrapper/gradle-wrapper.properties
        else
          echo "创建gradle-wrapper.properties..."
          mkdir -p gradle/wrapper
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-7.6.4-all.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
        fi
        
        # 确保有gradlew脚本
        if [ ! -f "gradlew" ]; then
          echo "下载gradlew..."
          curl -L https://raw.githubusercontent.com/gradle/gradle/master/gradlew -o gradlew
          chmod +x gradlew
        else
          chmod +x gradlew
        fi
        
        echo "Gradle配置完成"
    
    - name: 7. 清理并构建
      run: |
        echo "=== 开始构建 ==="
        
        # 设置环境变量
        export GRADLE_OPTS="-Dorg.gradle.daemon=false"
        
        # 显示Gradle版本
        ./gradlew --version
        
        # 第一步：清理
        echo "执行gradle clean..."
        ./gradlew clean
        
        # 第二步：构建debug版本
        echo "执行gradle assembleDebug..."
        ./gradlew assembleDebug \
          --stacktrace \
          --no-daemon \
          --warning-mode=summary \
          --info
        
        echo "构建完成！"
    
    - name: 8. 检查构建结果
      run: |
        echo "=== 构建结果 ==="
        
        # 检查APK文件
        if ls app/build/outputs/apk/debug/*.apk 1> /dev/null 2>&1; then
          echo "✅ APK生成成功！"
          echo "APK文件列表:"
          ls -lh app/build/outputs/apk/debug/*.apk
          
          # 显示APK基本信息
          for apk in app/build/outputs/apk/debug/*.apk; do
            echo ""
            echo "文件: $apk"
            file_size=$(stat -f%z "$apk" 2>/dev/null || stat -c%s "$apk" 2>/dev/null)
            echo "大小: $((file_size / 1024)) KB"
          done
        else
          echo "❌ 未找到APK文件"
          echo "检查build目录:"
          find app/build -type f -name "*.apk" 2>/dev/null || echo "无APK文件"
        fi
        
        # 显示build目录结构
        echo ""
        echo "=== build目录结构 ==="
        find app/build -type d | sort
    
    - name: 9. 上传APK文件
      uses: actions/upload-artifact@v4
      with:
        name: apk-artifact
        path: |
          app/build/outputs/apk/debug/*.apk
          app/build/outputs/**/*.apk
        if-no-files-found: warn
        retention-days: 7
    
    - name: 10. 上传构建日志（如果失败）
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          **/*.log
          app/build/reports/**/*
        retention-days: 3
