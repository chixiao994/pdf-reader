name: 构建APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. 检出代码
      uses: actions/checkout@v4
    
    - name: 2. 设置Java 17（必须）
      uses: actions/setup-java@v4
      with:
        java-version: '17'  # Android SDK需要JDK 17
        distribution: 'temurin'
    
    - name: 3. 验证Java版本
      run: |
        echo "Java版本:"
        java -version
        echo ""
        echo "JAVA_HOME: $JAVA_HOME"
    
    - name: 4. 手动设置Android SDK
      run: |
        echo "=== 设置Android SDK ==="
        
        # 设置Android SDK路径
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        
        # 创建必要目录
        mkdir -p $ANDROID_SDK_ROOT
        
        # 检查现有SDK
        echo "SDK目录内容:"
        ls -la $ANDROID_SDK_ROOT/ || echo "SDK目录为空"
    
    - name: 5. 安装Android SDK组件
      run: |
        echo "=== 安装Android SDK组件 ==="
        
        # 设置环境变量
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
        
        # 接受许可证（使用环境变量跳过JDK检查）
        SKIP_JDK_VERSION_CHECK=1 yes | sdkmanager --licenses || true
        
        # 安装必要组件（安静模式）
        sdkmanager \
          "platforms;android-33" \
          "build-tools;33.0.0" \
          "platform-tools" \
          --sdk_root=$ANDROID_SDK_ROOT \
          --verbose
        
        echo "SDK安装完成"
    
    - name: 6. 验证项目配置
      run: |
        echo "=== 验证项目配置 ==="
        
        # 确保local.properties存在
        echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties
        
        # 显示项目文件
        echo "build.gradle:"
        head -20 build.gradle
        
        echo ""
        echo "app/build.gradle:"
        head -30 app/build.gradle
        
        echo ""
        echo "项目结构:"
        find . -maxdepth 3 -type f -name "*.gradle" -o -name "*.java" -o -name "AndroidManifest.xml" | sort
    
    - name: 7. 设置Gradle Wrapper
      run: |
        echo "=== 设置Gradle Wrapper ==="
        
        # 创建或更新gradle-wrapper.properties
        mkdir -p gradle/wrapper
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-7.6.4-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        
        # 如果有gradlew，确保可执行
        if [ -f "gradlew" ]; then
          chmod +x gradlew
          echo "使用现有的gradlew"
        else
          echo "创建gradlew脚本"
          cat > gradlew << 'EOF'
          #!/bin/bash
          # 简单gradlew包装脚本
          java -version
          exec ./gradlew "$@"
          EOF
          chmod +x gradlew
        fi
    
    - name: 8. 构建APK
      run: |
        echo "=== 开始构建 ==="
        
        # 设置环境
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export GRADLE_OPTS="-Dorg.gradle.daemon=false"
        
        # 显示环境
        echo "Java版本:"
        java -version
        echo ""
        echo "Android SDK: $ANDROID_SDK_ROOT"
        
        # 如果gradlew不存在，创建它
        if [ ! -f "gradlew" ]; then
          echo "初始化gradle wrapper..."
          gradle wrapper --gradle-version=7.6.4 --distribution-type=bin
          chmod +x gradlew
        fi
        
        # 清理和构建
        echo "执行gradle clean..."
        ./gradlew clean
        
        echo "执行gradle assembleDebug..."
        ./gradlew assembleDebug \
          --stacktrace \
          --no-daemon \
          --warning-mode=summary \
          --info
        
        echo "✅ 构建完成！"
    
    - name: 9. 检查并上传APK
      run: |
        echo "=== 检查APK文件 ==="
        
        if ls app/build/outputs/apk/debug/*.apk 1>/dev/null 2>&1; then
          echo "✅ 找到APK文件:"
          ls -lh app/build/outputs/apk/debug/*.apk
          
          # 显示文件大小
          for apk in app/build/outputs/apk/debug/*.apk; do
            size=$(stat -f%z "$apk" 2>/dev/null || stat -c%s "$apk")
            echo "  $apk - $((size/1024))KB"
          done
        else
          echo "❌ 未找到APK文件"
          echo "搜索所有APK:"
          find . -name "*.apk" -type f 2>/dev/null || echo "无APK文件"
        fi
    
    - name: 10. 上传APK
      uses: actions/upload-artifact@v4
      with:
        name: apk
        path: |
          app/build/outputs/apk/debug/*.apk
          **/build/outputs/apk/**/*.apk
        if-no-files-found: warn
        retention-days: 7
