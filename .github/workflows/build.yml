name: 直接构建APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 使用Android SDK工具直接构建
      run: |
        echo "=== 使用Android SDK工具直接构建 ==="
        
        SDK_ROOT="/usr/local/lib/android/sdk"
        
        # 安装必要的工具
        yes | $SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
        $SDK_ROOT/cmdline-tools/latest/bin/sdkmanager \
          "platforms;android-33" \
          "build-tools;33.0.0" \
          --sdk_root=$SDK_ROOT
        
        # 创建项目目录结构
        mkdir -p app/src/main/java/com/pdf/reader
        mkdir -p app/src/main/res/values
        mkdir -p app/src/main/res/drawable
        
        # 复制源代码
        cp -r app/src/main/java/com/pdf/reader/* app/src/main/java/com/pdf/reader/ 2>/dev/null || true
        
        # 创建AndroidManifest.xml（如果不存在）
        if [ ! -f "app/src/main/AndroidManifest.xml" ]; then
          cat > app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.pdf.reader">

    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="PDF阅读器"
        android:theme="@style/Theme.AppCompat.Light.NoActionBar">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:screenOrientation="portrait">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF
        fi
        
        # 创建strings.xml（如果不存在）
        if [ ! -f "app/src/main/res/values/strings.xml" ]; then
          cat > app/src/main/res/values/strings.xml << 'EOF'
<resources>
    <string name="app_name">PDF阅读器</string>
</resources>
EOF
        fi
        
        # 创建简单的build.xml用于ant构建
        cat > build.xml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<project name="PDFReader" default="debug">
    <property file="local.properties" />
    <property file="ant.properties" />
    <property environment="env" />
    
    <condition property="sdk.dir" value="${env.ANDROID_SDK_ROOT}">
        <isset property="env.ANDROID_SDK_ROOT" />
    </condition>
    
    <loadproperties srcFile="project.properties" />
    
    <fail message="sdk.dir is missing." unless="sdk.dir" />
    
    <import file="${sdk.dir}/tools/ant/build.xml" />
</project>
EOF
        
        # 创建project.properties
        cat > project.properties << 'EOF'
target=android-33
android.library=false
EOF
        
        # 创建ant.properties
        echo "sdk.dir=$SDK_ROOT" > ant.properties
        
        # 尝试使用ant构建
        echo "尝试使用ant构建..."
        ant debug || echo "ant构建失败，尝试其他方法"
        
        echo "✅ 构建尝试完成"
    
    - uses: actions/upload-artifact@v4
      with:
        name: apk
        path: bin/*.apk
        if-no-files-found: warn
