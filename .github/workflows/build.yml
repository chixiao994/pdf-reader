name: 构建APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 设置Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: 验证Java版本
      run: |
        echo "Java版本信息:"
        java -version
        echo "JAVA_HOME: $JAVA_HOME"
    
    - name: 使用系统Android SDK
      run: |
        echo "=== 使用预装Android SDK ==="
        
        # Ubuntu runner已预装Android SDK
        SDK_ROOT="/usr/local/lib/android/sdk"
        echo "Android SDK路径: $SDK_ROOT"
        
        # 创建local.properties
        echo "sdk.dir=$SDK_ROOT" > local.properties
        
        # 显示SDK内容
        echo "SDK目录内容:"
        ls -la $SDK_ROOT/ || echo "无法访问SDK目录"
        
        # 接受许可证（静默模式）
        yes | $SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
        
        echo "✅ Android SDK配置完成"
    
    - name: 配置项目文件
      run: |
        echo "=== 配置项目 ==="
        
        # 显示原始项目文件
        echo "原始build.gradle:"
        cat build.gradle
        echo ""
        echo "原始app/build.gradle:"
        cat app/build.gradle
        
        # 创建最小化配置（不使用here-document）
        echo "创建最小化配置..."
        
        # 根目录build.gradle保持不变
        
        # 在app/build.gradle中添加Java 17兼容配置
        if ! grep -q "compileOptions" app/build.gradle; then
          echo "" >> app/build.gradle
          echo "compileOptions {" >> app/build.gradle
          echo "    sourceCompatibility JavaVersion.VERSION_17" >> app/build.gradle  
          echo "    targetCompatibility JavaVersion.VERSION_17" >> app/build.gradle
          echo "}" >> app/build.gradle
          echo "✅ 添加了Java 17编译选项"
        fi
        
        # 确保settings.gradle存在
        if [ ! -f "settings.gradle" ]; then
          echo "include ':app'" > settings.gradle
          echo "✅ 创建了settings.gradle"
        fi
    
    - name: 直接使用Gradle构建
      run: |
        echo "=== 开始构建 ==="
        
        # 设置环境
        export ANDROID_SDK_ROOT="/usr/local/lib/android/sdk"
        
        # 检查是否有gradlew
        if [ -f "gradlew" ]; then
          echo "使用项目gradlew构建..."
          chmod +x gradlew
          ./gradlew clean assembleDebug --stacktrace --no-daemon
        else
          echo "使用系统gradle构建..."
          gradle clean assembleDebug --stacktrace --no-daemon
        fi
        
        echo "✅ 构建完成"
    
    - name: 检查APK
      run: |
        echo "=== 检查构建结果 ==="
        
        # 查找APK文件
        APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null)
        
        if [ -n "$APK_FILES" ]; then
          echo "✅ 找到APK文件:"
          for file in $APK_FILES; do
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
            echo "  $file ($((size/1024)) KB)"
          done
        else
          echo "❌ 未找到APK文件"
          echo "检查build目录:"
          find app/build -type d 2>/dev/null | head -10
        fi
    
    - uses: actions/upload-artifact@v4
      with:
        name: apk-artifact
        path: |
          app/build/outputs/apk/debug/*.apk
          **/build/outputs/apk/**/*.apk
        if-no-files-found: warn
