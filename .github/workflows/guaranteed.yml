name: 修复构建

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. 检出代码
      uses: actions/checkout@v4
      
    - name: 2. 设置Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: 3. 设置Android SDK
      run: |
        # 使用系统预装的Android SDK
        echo "Android SDK路径: $ANDROID_SDK_ROOT"
        
        # 接受许可证
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
        
    - name: 4. 修复项目文件
      run: |
        # 创建settings.gradle
        echo "rootProject.name = 'PDFReader'" > settings.gradle
        echo "include ':app'" >> settings.gradle
        
        # 创建gradle.properties
        echo "org.gradle.jvmargs=-Xmx2048m" > gradle.properties
        echo "android.useAndroidX=true" >> gradle.properties
        echo "android.enableJetifier=true" >> gradle.properties
        
        # 创建local.properties
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        
    - name: 5. 检查当前文件
      run: |
        echo "=== 当前文件 ==="
        find . -type f -name "*.java" -o -name "*.gradle" -o -name "*.xml" | sort
        
    - name: 6. 直接构建（不使用复杂脚本）
      run: |
        # 进入app目录
        cd app
        
        # 显示当前目录
        echo "当前目录: $(pwd)"
        ls -la
        
        # 直接使用gradle命令构建
        echo "开始构建..."
        gradle clean assembleDebug --stacktrace --no-daemon
        
    - name: 7. 查找APK
      run: |
        echo "查找APK文件..."
        find . -name "*.apk" -type f 2>/dev/null
        
    - name: 8. 上传结果
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: |
          app/build/outputs/apk/debug/*.apk
        if-no-files-found: warn
