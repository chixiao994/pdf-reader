name: 构建APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. 检出代码
      uses: actions/checkout@v4
      
    - name: 2. 设置Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: 3. 手动设置Android SDK
      run: |
        # 设置Android SDK路径
        echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        
        # 创建必要目录
        mkdir -p /usr/local/lib/android/sdk
        
    - name: 4. 安装Android SDK组件
      run: |
        # 接受所有许可证
        yes | /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1
        
        # 安装必要组件
        /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-34" \
          "build-tools;34.0.0" \
          "cmdline-tools;latest" \
          --sdk_root=/usr/local/lib/android/sdk
        
    - name: 5. 创建必要文件
      run: |
        # 确保local.properties存在
        echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties
        
        # 显示项目结构
        echo "=== 项目结构 ==="
        find . -type f \( -name "*.gradle" -o -name "*.xml" -o -name "*.java" \) | sort
        
    - name: 6. 使用系统Gradle构建（修复版）
      run: |
        echo "=== 开始构建 ==="
        
        # 设置环境变量
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
        
        # 显示gradle版本
        gradle --version
        
        # 清理并构建
        echo "执行gradle clean..."
        gradle clean
        
        echo "执行gradle assembleDebug..."
        gradle assembleDebug --stacktrace --no-daemon
        
        # 或者使用更详细的构建
        # ./gradlew clean assembleDebug --stacktrace --no-daemon
        
    - name: 7. 查找并上传APK
      run: |
        echo "=== 查找APK文件 ==="
        find . -name "*.apk" -type f 2>/dev/null
        
        # 列出build目录
        echo ""
        echo "=== build目录内容 ==="
        find . -path "*/build/outputs/apk/*" -name "*.apk" 2>/dev/null || echo "未找到APK"
        
    - name: 8. 上传APK文件
      uses: actions/upload-artifact@v4
      with:
        name: apk-artifact
        path: |
          app/build/outputs/apk/**/*.apk
          **/build/outputs/apk/**/*.apk
          *.apk
        if-no-files-found: warn
